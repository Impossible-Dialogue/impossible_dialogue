# Funkadelephant Lights
This project develops a new light system for the Funkadelephant art car. 

Design doc:
https://docs.google.com/document/d/193zCBdZJQ2zM1hZOcOoi2PbTF1X6veQUsoNvbH2qYzI/edit#heading=h.bk4r5cyiqgef

Photos of Funkadelephant BEFORE the lights upgrades:
https://photos.app.goo.gl/gXQorENS9bhVreZ16

3D Mesh files for the Funkadelephant art car:
https://drive.google.com/drive/folders/1XdZmZc8DAyeh26kRkMO6nCtN7fgZzTzO?usp=sharing

## attiny85 board
Each LED segment is controlled by a small attiny85 based board. The software for the board is in [attiny/attiny.ino](attiny/attiny.ino) file.

Here are the steps to setup and program the board.

### Set fuses and UID
You first need to burn the flash fuses with the correct values to set the clock to 16Mhz internal and to enable Brown-out detection. There is a way to set the correct clock with the Arduino IDE, but it doesn’t enable the brown out detector. We also program the UID into the EEPROM and lock it using the EESAVE fuse to it persists when we update the application firmware. 
Here is the full list of fuse bits we need to set:

| Fuse          | Fuse Bit      | Notes                                                             |
| ------------- | ------------- | ----------------------------------------------------------------- |
| LOW           | CKSEL1        |                                                                   |
| LOW           | CKSEL2        |                                                                   |
| LOW           | CKSEL3        |                                                                   |
| HIGH          | SPIEN         |                                                                   |
| HIGH          | BODLEVEL2     | BODLEVEL 100 configure the brown out detector to 4.3V             | 
| HIGH          | EESAVE        | Lock EEPROM so it doesn’t get erased when programming             |
| EXTENDED      | SELFPRGEN     | Allow bootloader to program the flash                             |       

Here is the command to set the fuses:
``` 
SEGMENT_UID=7
/Applications/Arduino.app/Contents/Java/hardware/tools/avr/bin/avrdude -C/Applications/Arduino.app/Contents/Java/hardware/tools/avr/etc/avrdude.conf -v -v -v -v -pattiny85 -cusbtiny -e -Uefuse:w:0xfe:m -Uhfuse:w:0xd3:m -Ulfuse:w:0xf1:m -Ueeprom:w:0x$(printf "%.2x" $SEGMENT_UID):m
``` 

### Program bootloader 
Next we burn a bootloader onto the board that will enable us to program the boards over serial going forward. With the programmer still attached build and burn the bootloader using the following commands:
``` 
cd bootloader
./make.sh
./burn.sh
``` 
After burning the bootloader will start immediately and display the UID on the LEDs. It will also output some debug information on pin 2.
If all looks good, disconnect the USB ISP programmer.

### Program main application 
The main application is in [attiny/attiny.ino](attiny/attiny.ino) and the compiled hex file is in [attiny/attiny.ino.tiny8.hex](attiny/attiny.ino.tiny8.hex). If the ino file is changed a new hex file can be generated using the Arduino IDU under `Sketch -> Export Compiled Binary`. This should overwrite [attiny/attiny.ino.tiny8.hex](attiny/attiny.ino.tiny8.hex).
NOTE: do NOT use the Arduino IDE or avrdude to program the main application. This will remove the bootloader.

To program the main application, connect to the (LED) serial and run:
``` 
cd controller
python flash_application.py
``` 
Note, flash_application will update the main application on all boards connected to the bus by default. Change the UID if only one boards should be updated.


## Visualization

The visualization consists of two parts right now. A server that serves LED control packets over websockets and a 3D visualizer written in javasript and three.js.

Note: the websockets server is currently not connected and reimplementing funky_lights.py. This should change. Either the two programs should become one or the websockets server should be able to listen to the serial coms created by funky_lights.py.

To start the websockets server:
``` 
cd visualization
python server.py
``` 

To start a webserver for the 3D visualizer run in the same folder:
``` 
python -m http.server
``` 

Now point a browser to http://localhost:8000/three.js/editor 

The LED configuration is loaded when opening the page. The Funky 3D object can be loaded optionally loaded (File->Import->funky.obj or File->Import->dome.obj). Also add some light sources (Add->Ambient/Directional lights).

The LED configuration was generated by fitting a 3D line to the mesh of one of the dome tubes, sampling 30 points along this line, and writing everything out in a simple JSON config format.

Run the following script to update the config:
``` 
python generate_led_config.py
``` 

Video of the prototype: https://youtu.be/v4KDhiCZiSY